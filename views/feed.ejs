<%- include('./partials/header') %>

<main>
  <div class="container position-relative">

    <!-- Bot√£o de Criar Novo Post -->
    <button id="btnFlutuante" class="btn" data-bs-toggle="modal" data-bs-target="#novoPostModal"
      aria-label="Criar Novo Post">
      <img src="../icons/mdi_pencil-plus.svg" alt="√çcone bot√£o criar post" width="24" height="24">
    </button>

    <!-- Modal de Novo Post -->
    <div class="modal fade" id="novoPostModal" tabindex="-1" aria-labelledby="novoPostModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formNovoPost">
            <div class="modal-header">
              <h5 class="modal-title" id="novoPostModalLabel">Novo Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="textoPost" class="form-label">Texto</label>
                <textarea class="form-control" id="textoPost" rows="3" required></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Publicar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Lista de posts -->
    <div id="posts-container">
      <% posts.forEach(post => { %>
        <div class="card mb-3 border rounded-0 min-h-125" data-post-id="<%= post._id %>">
          <div class="card-body d-flex">
            <% if (post.author && post.author.foto && post.author.foto.data) { %>
              <img
                src="data:<%= post.author.foto.contentType %>;base64,<%= post.author.foto.data.toString('base64') %>"
                class="rounded-circle me-3" width="50" height="50" alt="Foto de perfil">
            <% } else { %>
              <img src="../images/foto_usuario.jpg" class="rounded-circle me-3" width="50" height="50"
                alt="Foto de perfil padr√£o">
            <% } %>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-0 fw-bold">
                    <% if (post.author) { %>
                      <%= post.author.nome %>
                      <span class="badge
                        <% if (post.author.curso === 'Inform√°tica') { %> bg-warning text-dark <% } 
                           else if (post.author.curso === 'Eletrot√©cnica') { %> bg-primary text-white <% } 
                           else if (post.author.curso === 'Edifica√ß√µes') { %> bg-danger text-white <% } 
                           else if (post.author.curso === 'Qu√≠mica') { %> bg-dark text-white <% } 
                           else if (post.author.curso === 'Mec√¢nica') { %> bg-success text-white <% } 
                           else if (post.author.curso === 'Telecomunica√ß√µes') { %> bg-info text-white <% } 
                           else { %> bg-secondary text-white <% } %> ms-2">
                        <%= post.author.curso %>
                      </span>
                    <% } else { %>
                      <em>Autor desconhecido</em>
                    <% } %>
                  </h6>
                </div>
                <div>
                  <div class="dropdown">
                    <button class="btn-icon dropdown-toggle" type="button" id="dropdownMenu<%= post._id %>"
                      data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu<%= post._id %>">
                      <li><a class="dropdown-item btn-editar-post" href="#" data-id="<%= post._id %>"
                          data-texto="<%= post.message.replace(/"/g, '&quot;') %>">‚úèÔ∏è Editar</a></li>
                      <li><a class="dropdown-item btn-excluir-post" href="#" data-id="<%= post._id %>">üóëÔ∏è
                          Excluir</a></li>
                    </ul>
                  </div>
                </div>
              </div>
              <p class="mt-1 mb-1" style="white-space: pre-wrap;">
                <%= post.message %>
              </p>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</main>

<!-- Modal Editar Post -->
<div class="modal fade" id="modalEditarPost" tabindex="-1" aria-labelledby="modalEditarPostLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarPost">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarPostLabel">Editar Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <textarea id="inputEditarTexto" class="form-control" rows="4" required></textarea>
          <input type="hidden" id="inputEditarId" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Excluir Post -->
<div class="modal fade" id="modalExcluirPost" tabindex="-1" aria-labelledby="modalExcluirPostLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalExcluirPostLabel">Confirmar Exclus√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir este post?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnConfirmarExcluir" type="button" class="btn btn-danger">Excluir</button>
      </div>
    </div>
  </div>
</div>

<footer>
  <%- include('./partials/footer') %>
</footer>

<style>
  .btn-icon {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .btn-icon:hover {
    opacity: 0.7;
  }

  .btn-icon i {
    font-size: 1.2rem;
    color: inherit;
  }

  #btnFlutuante {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1050;
    width: 50px;
    height: 50px;
    border: none;
    border-radius: 15px;
    background-color: #B9E185;
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
  crossorigin="anonymous"></script>

<script>
  document.getElementById('formNovoPost').addEventListener('submit', async function (e) {
    e.preventDefault();
    const texto = document.getElementById('textoPost').value;

    try {
      const response = await fetch('/posts/criar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: texto })
      });

      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Erro ao criar post.');
      }
    } catch (err) {
      console.error(err);
      alert('Erro de conex√£o com o servidor.');
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    const usuarioLogado = JSON.parse('<%= JSON.stringify(usuario || null) %>');

    const modalEditar = new bootstrap.Modal(document.getElementById('modalEditarPost'));
    const modalExcluir = new bootstrap.Modal(document.getElementById('modalExcluirPost'));
    const inputEditarTexto = document.getElementById('inputEditarTexto');
    const inputEditarId = document.getElementById('inputEditarId');
    let postIdExcluir = null;

    document.querySelectorAll('.btn-editar-post').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        if (!usuarioLogado) {
          alert('Fa√ßa login para editar posts.');
          return;
        }
        const id = btn.dataset.id;
        const texto = btn.dataset.texto || '';
        inputEditarId.value = id;
        inputEditarTexto.value = texto;
        modalEditar.show();
      });
    });

    document.getElementById('formEditarPost').addEventListener('submit', async e => {
      e.preventDefault();
      if (!usuarioLogado) {
        alert('Fa√ßa login para editar posts.');
        return;
      }
      const id = inputEditarId.value;
      const texto = inputEditarTexto.value.trim();
      if (!texto) {
        alert('O texto n√£o pode estar vazio.');
        return;
      }
      try {
        const res = await fetch(`/posts/${id}/editar`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: texto })
        });
        const data = await res.json();
        if (data.success) {
          modalEditar.hide();
          location.reload();
        } else {
          alert('Erro ao editar o post.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro na conex√£o.');
      }
    });

    document.querySelectorAll('.btn-excluir-post').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        if (!usuarioLogado) {
          alert('Fa√ßa login para excluir posts.');
          return;
        }
        postIdExcluir = btn.dataset.id;
        modalExcluir.show();
      });
    });

    document.getElementById('btnConfirmarExcluir').addEventListener('click', async () => {
      if (!postIdExcluir) return;
      try {
        const res = await fetch(`/posts/${postIdExcluir}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          modalExcluir.hide();
          location.reload();
        } else {
          alert('Erro ao excluir o post.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro na conex√£o.');
      }
    });

  });
</script>

</body>
</html>
